# Task 5: Validation Workflow Controls - 设计文档

> **任务名称**: 验证工作流控制
> **创建时间**: 2025-10-23
> **状态**: 设计中

---

## 📋 需求分析

### 功能描述
实现用户控件以手动触发验证,可选择在输入更改时自动验证,并提供清晰的成功或失败反馈。

### 验收标准
1. ✅ **验证按钮运行验证并更新状态指示器**
   - 点击验证按钮后触发验证
   - 状态指示器实时更新(未验证 → 处理中 → 成功/失败)

2. ✅ **自动验证切换保持用户选择并在启用时重新验证输入编辑**
   - 提供自动验证开关(复选框或切换按钮)
   - 用户选择需要持久化(localStorage)
   - 启用时,输入变化自动触发验证(带防抖)
   - 禁用时,仅手动点击验证按钮触发

3. ✅ **成功状态显示确认文本/图标;失败状态显示错误摘要**
   - 成功: 绿色指示器 + ✓ 图标 + "有效 JSON" 文本
   - 失败: 红色指示器 + ✗ 图标 + 错误摘要
   - 未验证: 灰色指示器 + 提示文本

---

## 🎨 UI/UX 设计

### 1. 工具栏布局调整

当前工具栏已有验证按钮,需要增加:
- **自动验证切换开关** (在工具栏右侧选项组)
- **状态指示器增强** (显示更详细的状态信息)

```
┌─────────────────────────────────────────────────────────────────┐
│ [验证] [格式化] [压缩] [清空]  │ 缩进: [2空格▾] ☑尾部换行 ☑自动验证 │ ⬤ 状态 │
└─────────────────────────────────────────────────────────────────┘
```

### 2. 状态指示器设计

**当前状态**:
- `idle`: "未验证" (灰色)
- `success`: "✓ 有效" (绿色)
- `error`: "✗ 错误" (红色)

**增强后**:
- `idle`: "⚪ 未验证" (灰色)
- `validating`: "⏳ 验证中..." (蓝色,带动画)
- `success`: "✓ JSON 有效" (绿色)
- `error`: "✗ JSON 无效" (红色) + 悬停显示错误摘要

### 3. 成功状态反馈

```
┌────────────────────────────────┐
│ ✓ JSON 有效                    │
│ - 对象包含 X 个键              │
│ - 文档大小: XX KB              │
│ - 嵌套深度: X 层               │
└────────────────────────────────┘
```

### 4. 失败状态反馈

```
┌────────────────────────────────┐
│ ✗ JSON 无效                    │
│ 错误: 缺少逗号分隔符           │
│ 位置: 第 3 行, 第 12 列        │
└────────────────────────────────┘
```

---

## 🏗️ 技术实现

### 1. 状态管理

#### 新增状态类型
```typescript
type ValidationStatus = 'idle' | 'validating' | 'success' | 'error'
```

#### 偏好设置持久化
```typescript
interface UserPreferences {
  autoValidate: boolean
  formattingOptions: FormattingOptions
}

// 使用 localStorage 存储
const PREFS_KEY = 'json-tool-preferences'
```

### 2. 自动验证逻辑

#### 防抖策略
- 用户输入停止后 500ms 自动触发验证
- 避免频繁验证导致性能问题
- 使用 `useDebouncedCallback` 或自定义 hook

```typescript
const debouncedValidate = useMemo(
  () => debounce(handleValidate, 500),
  [handleValidate]
)

useEffect(() => {
  if (autoValidate && inputJson.trim()) {
    debouncedValidate()
  }
}, [inputJson, autoValidate, debouncedValidate])
```

### 3. 状态指示器增强

#### 额外信息展示
- 成功时显示 JSON 结构信息
- 失败时显示错误摘要
- 使用 Tooltip 或可展开面板

### 4. 组件结构

#### 新增组件
- `AutoValidateToggle.tsx`: 自动验证开关
- `ValidationStatusPanel.tsx`: 详细状态面板(可选)

#### 修改组件
- `Toolbar.tsx`: 添加自动验证开关
- `App.tsx`: 实现自动验证逻辑和偏好持久化

---

## 📁 文件变更清单

### 新增文件
1. `src/hooks/useDebounce.ts` - 防抖 Hook
2. `src/hooks/usePreferences.ts` - 偏好管理 Hook
3. `src/utils/localStorage.ts` - localStorage 工具函数

### 修改文件
1. `src/App.tsx`
   - 添加 `autoValidate` 状态
   - 实现自动验证逻辑(带防抖)
   - 集成偏好持久化
   - 更新状态类型为 4 种状态

2. `src/components/Toolbar.tsx`
   - 添加自动验证切换开关
   - 传递 `autoValidate` 和 `onAutoValidateChange` props
   - 增强状态指示器显示

3. `src/styles.css`
   - 添加 `status-validating` 样式(蓝色,带动画)
   - 优化状态指示器样式
   - 添加加载动画

---

## 🔄 用户流程

### 流程 1: 手动验证
```
用户输入 JSON
    ↓
点击"验证"按钮
    ↓
状态: idle → validating
    ↓
后端验证处理
    ↓
状态: validating → success/error
    ↓
显示验证结果
```

### 流程 2: 自动验证(开启)
```
用户输入 JSON
    ↓
500ms 防抖延迟
    ↓
自动触发验证
    ↓
状态: idle → validating → success/error
    ↓
显示验证结果
```

### 流程 3: 自动验证切换
```
点击"自动验证"开关
    ↓
保存到 localStorage
    ↓
更新 UI 状态
    ↓
如果开启 + 有输入 → 立即验证
```

---

## 🧪 测试计划

### 单元测试
- [ ] localStorage 读写功能
- [ ] 防抖函数正确性
- [ ] 偏好状态管理

### 集成测试
- [ ] 手动验证按钮功能
- [ ] 自动验证开关切换
- [ ] 偏好持久化(刷新页面后保持)
- [ ] 防抖验证(输入后 500ms 触发)

### UI/UX 测试
- [ ] 状态指示器颜色和文本正确
- [ ] 成功状态显示详细信息
- [ ] 失败状态显示错误摘要
- [ ] 验证中状态显示加载动画
- [ ] 自动验证开关可正常切换

### 性能测试
- [ ] 大 JSON (5MB) 自动验证不卡顿
- [ ] 快速输入时防抖正常工作
- [ ] 多次验证不造成内存泄漏

---

## ⚠️ 注意事项

### 1. 性能优化
- **防抖延迟**: 500ms 平衡响应性和性能
- **大文件处理**: 超过 1MB 提示用户手动验证
- **取消机制**: 输入变化时取消上一次验证请求

### 2. 用户体验
- **即时反馈**: 按钮点击后立即显示"验证中"状态
- **错误恢复**: 验证失败不清空输出(保留上次成功结果)
- **视觉反馈**: 使用动画和颜色变化增强反馈

### 3. 边界情况
- 空输入时禁用自动验证
- 仅空白字符输入不触发验证
- localStorage 不可用时使用内存存储

---

## 📊 验收检查清单

开发完成后,按以下清单逐项检查:

- [ ] ✅ 点击"验证"按钮触发验证并更新状态指示器
- [ ] ✅ 状态指示器显示 4 种状态(未验证/验证中/成功/失败)
- [ ] ✅ 添加"自动验证"切换开关
- [ ] ✅ 自动验证开关状态持久化到 localStorage
- [ ] ✅ 启用自动验证时,输入变化自动触发验证(500ms 防抖)
- [ ] ✅ 禁用自动验证时,仅手动点击触发
- [ ] ✅ 成功状态显示绿色 + ✓ 图标 + "JSON 有效"
- [ ] ✅ 失败状态显示红色 + ✗ 图标 + 错误消息
- [ ] ✅ 验证中状态显示蓝色 + 加载动画
- [ ] ✅ 刷新页面后自动验证设置保持不变
- [ ] ✅ 快速输入时防抖正常工作(不会触发多次验证)
- [ ] ✅ 大文件(5MB)验证不阻塞 UI

---

## 🚀 实施步骤

### Phase 1: 基础设施 (30 分钟)
1. 创建 `useDebounce` Hook
2. 创建 `usePreferences` Hook
3. 创建 localStorage 工具函数

### Phase 2: UI 更新 (30 分钟)
1. 更新 `Toolbar.tsx` 添加自动验证开关
2. 更新状态类型和样式
3. 添加验证中的加载动画

### Phase 3: 逻辑实现 (45 分钟)
1. 在 `App.tsx` 实现自动验证逻辑
2. 集成防抖和偏好持久化
3. 处理边界情况

### Phase 4: 测试与优化 (30 分钟)
1. 手动测试所有功能
2. 性能测试(大文件)
3. 边界情况测试
4. UI/UX 优化

**预计总时长**: 2-2.5 小时

---

## 📝 补充说明

### 与其他任务的关联
- **Task 7**: 偏好持久化机制可复用
- **Task 13**: 状态指示器将在 Task 13 进一步增强
- **Task 14**: 性能优化需考虑大文件场景

### 未来增强
- 验证历史记录
- 验证统计信息
- 自定义防抖延迟
- 验证规则配置

---

**文档版本**: 1.0
**审核状态**: 待审核
**预计开始**: 2025-10-23
